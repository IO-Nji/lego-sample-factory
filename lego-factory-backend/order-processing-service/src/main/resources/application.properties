spring.application.name=order-processing-service
server.port=${ORDER_PROCESSING_SERVICE_PORT:8015}

# Import environment variables
spring.config.import=optional:file:../../.env

# H2 Database Configuration (Development) - FIXED
spring.datasource.url=${H2_DB_ORDER_PROCESSING_PATH:jdbc:h2:mem:order_processing_db;DB_CLOSE_DELAY=-1}
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=password

spring.jpa.hibernate.ddl-auto=${SPRING_JPA_HIBERNATE_DDL_AUTO:create-drop}
spring.jpa.show-sql=${SPRING_JPA_SHOW_SQL:true}
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect

# H2 Console Configuration
spring.h2.console.enabled=${SPRING_H2_CONSOLE_ENABLED:true}
spring.h2.console.path=${SPRING_H2_CONSOLE_PATH:/h2-console}
spring.h2.console.settings.web-allow-others=true
spring.h2.console.settings.trace=false

# Disable JMX to prevent connection issues
spring.jmx.enabled=${SPRING_JMX_ENABLED:false}

# Actuator Configuration
management.endpoints.web.exposure.include=${MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE:health,info,metrics}
management.endpoint.health.show-details=${MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS:always}
management.health.db.enabled=true
management.endpoints.web.base-path=/actuator
management.server.port=${server.port}

# SimAL Integration Service Configuration
simal.api.base-url=${SIMAL_API_BASE_URL:http://simal-integration-service:8016/api}
simal.api.scheduled-orders-path=/simal/scheduled-orders/

# Logging Configuration
logging.level.io.life=${LOGGING_LEVEL_IO_LIFE:DEBUG}
logging.level.root=${LOG_LEVEL_ROOT:INFO}
logging.level.org.springframework.web=DEBUG

# OpenAPI / Swagger Configuration
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.url=/v3/api-docs
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.operationsSorter=method
springdoc.swagger-ui.tagsSorter=alpha
springdoc.swagger-ui.disable-swagger-default-url=true

# ================================================
# Order Processing Configuration (Externalized)
# ================================================

# Thresholds - Business Rules
life.order-processing.thresholds.lot-size-threshold=${LOT_SIZE_THRESHOLD:3}
life.order-processing.thresholds.max-order-items=${MAX_ORDER_ITEMS:100}
life.order-processing.thresholds.stock-reserve-minutes=${STOCK_RESERVE_MINUTES:30}
life.order-processing.thresholds.stock-safety-margin-percent=${STOCK_SAFETY_MARGIN:10}
life.order-processing.thresholds.max-retries=${MAX_RETRIES:3}

# Timeouts - External Service Calls (milliseconds)
life.order-processing.timeouts.masterdata-read-ms=${MASTERDATA_READ_TIMEOUT:5000}
life.order-processing.timeouts.masterdata-write-ms=${MASTERDATA_WRITE_TIMEOUT:10000}
life.order-processing.timeouts.inventory-read-ms=${INVENTORY_READ_TIMEOUT:3000}
life.order-processing.timeouts.inventory-write-ms=${INVENTORY_WRITE_TIMEOUT:10000}
life.order-processing.timeouts.simal-schedule-ms=${SIMAL_SCHEDULE_TIMEOUT:30000}
life.order-processing.timeouts.simal-task-update-ms=${SIMAL_TASK_UPDATE_TIMEOUT:5000}
life.order-processing.timeouts.user-service-ms=${USER_SERVICE_TIMEOUT:3000}

# Workstations - IDs
life.order-processing.workstations.injection-molding=${WS_INJECTION_MOLDING:1}
life.order-processing.workstations.parts-pre-production=${WS_PARTS_PRE_PRODUCTION:2}
life.order-processing.workstations.part-finishing=${WS_PART_FINISHING:3}
life.order-processing.workstations.gear-assembly=${WS_GEAR_ASSEMBLY:4}
life.order-processing.workstations.motor-assembly=${WS_MOTOR_ASSEMBLY:5}
life.order-processing.workstations.final-assembly=${WS_FINAL_ASSEMBLY:6}
life.order-processing.workstations.plant-warehouse=${WS_PLANT_WAREHOUSE:7}
life.order-processing.workstations.modules-supermarket=${WS_MODULES_SUPERMARKET:8}
life.order-processing.workstations.parts-supply=${WS_PARTS_SUPPLY:9}

# Feature Flags
life.order-processing.features.enable-caching=${ENABLE_CACHING:true}
life.order-processing.features.enable-async-processing=${ENABLE_ASYNC:false}
life.order-processing.features.enable-circuit-breaker=${ENABLE_CIRCUIT_BREAKER:true}
life.order-processing.features.enable-metrics=${ENABLE_METRICS:true}
life.order-processing.features.enable-detailed-logging=${ENABLE_DETAILED_LOGGING:true}
life.order-processing.features.enable-auto-status-propagation=${ENABLE_AUTO_STATUS_PROPAGATION:true}

# ================================================
# Resilience4j Circuit Breaker Configuration
# ================================================

# Inventory Service Circuit Breaker
resilience4j.circuitbreaker.instances.inventoryService.slidingWindowType=COUNT_BASED
resilience4j.circuitbreaker.instances.inventoryService.slidingWindowSize=10
resilience4j.circuitbreaker.instances.inventoryService.minimumNumberOfCalls=5
resilience4j.circuitbreaker.instances.inventoryService.failureRateThreshold=50
resilience4j.circuitbreaker.instances.inventoryService.waitDurationInOpenState=30s
resilience4j.circuitbreaker.instances.inventoryService.permittedNumberOfCallsInHalfOpenState=3
resilience4j.circuitbreaker.instances.inventoryService.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.instances.inventoryService.recordExceptions=java.io.IOException,java.util.concurrent.TimeoutException,org.springframework.web.client.ResourceAccessException,org.springframework.web.client.HttpServerErrorException

# Masterdata Service Circuit Breaker
resilience4j.circuitbreaker.instances.masterdataService.slidingWindowType=COUNT_BASED
resilience4j.circuitbreaker.instances.masterdataService.slidingWindowSize=10
resilience4j.circuitbreaker.instances.masterdataService.minimumNumberOfCalls=5
resilience4j.circuitbreaker.instances.masterdataService.failureRateThreshold=50
resilience4j.circuitbreaker.instances.masterdataService.waitDurationInOpenState=30s
resilience4j.circuitbreaker.instances.masterdataService.permittedNumberOfCallsInHalfOpenState=3
resilience4j.circuitbreaker.instances.masterdataService.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.instances.masterdataService.recordExceptions=java.io.IOException,java.util.concurrent.TimeoutException,org.springframework.web.client.ResourceAccessException,org.springframework.web.client.HttpServerErrorException

# SimAL Service Circuit Breaker (longer timeout for scheduling operations)
resilience4j.circuitbreaker.instances.simalService.slidingWindowType=COUNT_BASED
resilience4j.circuitbreaker.instances.simalService.slidingWindowSize=5
resilience4j.circuitbreaker.instances.simalService.minimumNumberOfCalls=3
resilience4j.circuitbreaker.instances.simalService.failureRateThreshold=60
resilience4j.circuitbreaker.instances.simalService.waitDurationInOpenState=60s
resilience4j.circuitbreaker.instances.simalService.permittedNumberOfCallsInHalfOpenState=2
resilience4j.circuitbreaker.instances.simalService.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.instances.simalService.recordExceptions=java.io.IOException,java.util.concurrent.TimeoutException,org.springframework.web.client.ResourceAccessException,org.springframework.web.client.HttpServerErrorException

# ================================================
# Resilience4j Retry Configuration
# ================================================

# Inventory Service Retry
resilience4j.retry.instances.inventoryService.maxAttempts=3
resilience4j.retry.instances.inventoryService.waitDuration=1s
resilience4j.retry.instances.inventoryService.enableExponentialBackoff=true
resilience4j.retry.instances.inventoryService.exponentialBackoffMultiplier=2
resilience4j.retry.instances.inventoryService.retryExceptions=java.io.IOException,java.util.concurrent.TimeoutException,org.springframework.web.client.ResourceAccessException

# Masterdata Service Retry
resilience4j.retry.instances.masterdataService.maxAttempts=3
resilience4j.retry.instances.masterdataService.waitDuration=500ms
resilience4j.retry.instances.masterdataService.enableExponentialBackoff=true
resilience4j.retry.instances.masterdataService.exponentialBackoffMultiplier=2
resilience4j.retry.instances.masterdataService.retryExceptions=java.io.IOException,java.util.concurrent.TimeoutException,org.springframework.web.client.ResourceAccessException

# SimAL Service Retry
resilience4j.retry.instances.simalService.maxAttempts=2
resilience4j.retry.instances.simalService.waitDuration=2s
resilience4j.retry.instances.simalService.enableExponentialBackoff=true
resilience4j.retry.instances.simalService.exponentialBackoffMultiplier=2
resilience4j.retry.instances.simalService.retryExceptions=java.io.IOException,java.util.concurrent.TimeoutException,org.springframework.web.client.ResourceAccessException

# ================================================
# Resilience4j TimeLimiter Configuration
# ================================================

resilience4j.timelimiter.instances.inventoryService.timeoutDuration=5s
resilience4j.timelimiter.instances.masterdataService.timeoutDuration=5s
resilience4j.timelimiter.instances.simalService.timeoutDuration=30s

# Order Numbers - Prefixes and Settings
life.order-processing.order-numbers.customer-order-prefix=${CUSTOMER_ORDER_PREFIX:ORD-}
life.order-processing.order-numbers.warehouse-order-prefix=${WAREHOUSE_ORDER_PREFIX:WO-}
life.order-processing.order-numbers.production-order-prefix=${PRODUCTION_ORDER_PREFIX:PO-}
life.order-processing.order-numbers.final-assembly-order-prefix=${FINAL_ASSEMBLY_ORDER_PREFIX:FA-}
life.order-processing.order-numbers.supply-order-prefix=${SUPPLY_ORDER_PREFIX:SO-}
life.order-processing.order-numbers.random-suffix-length=${ORDER_NUMBER_SUFFIX_LENGTH:8}

# ================================================
# Redis Cache Configuration (Phase 3 - Feb 4, 2026)
# ================================================

# Cache type: redis for production, simple for dev without Redis
spring.cache.type=${CACHE_TYPE:simple}

# Redis connection settings
spring.data.redis.host=${REDIS_HOST:redis}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}
spring.data.redis.timeout=${REDIS_TIMEOUT:2000ms}

# Redis connection pool settings
spring.data.redis.lettuce.pool.enabled=true
spring.data.redis.lettuce.pool.max-active=${REDIS_POOL_MAX_ACTIVE:8}
spring.data.redis.lettuce.pool.max-idle=${REDIS_POOL_MAX_IDLE:8}
spring.data.redis.lettuce.pool.min-idle=${REDIS_POOL_MIN_IDLE:2}
spring.data.redis.lettuce.pool.max-wait=${REDIS_POOL_MAX_WAIT:1000ms}

# Cache TTL settings (seconds)
life.order-processing.cache.masterdata-ttl-seconds=${CACHE_MASTERDATA_TTL:600}
life.order-processing.cache.inventory-ttl-seconds=${CACHE_INVENTORY_TTL:30}
life.order-processing.cache.product-modules-ttl-seconds=${CACHE_PRODUCT_MODULES_TTL:3600}
life.order-processing.cache.module-parts-ttl-seconds=${CACHE_MODULE_PARTS_TTL:3600}