services:
  # ==============================================
  # ROOT NGINX PROXY - Entry point for all traffic
  # ==============================================
  nginx-root-proxy:
    build:
      context: ./nginx-root-proxy
      dockerfile: Dockerfile
    ports:
      - "${NGINX_ROOT_PROXY_EXTERNAL_PORT:-1011}:80"
    depends_on:
      - frontend
      - api-gateway
    networks:
      - lego-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================
  # FRONTEND - React Application
  # ==============================================
  frontend:
    build:
      context: ./lego-factory-frontend
      dockerfile: Dockerfile
      args:
        VITE_API_GATEWAY_URL: /api
    ports:
      - "8080:80"
    environment:
      - NODE_ENV=production
    depends_on:
      - api-gateway
    networks:
      - lego-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================
  # API GATEWAY - Central routing service
  # ==============================================
  api-gateway:
    build:
      context: ./lego-factory-backend/api-gateway
      dockerfile: Dockerfile
    ports:
      - "${API_GATEWAY_HOST_PORT}:${API_GATEWAY_PORT}"
    environment:
      - SERVER_PORT=${API_GATEWAY_PORT}
      - SECURITY_JWT_SECRET=${SECURITY_JWT_SECRET}
      - SECURITY_JWT_EXPIRATION=${SECURITY_JWT_EXPIRATION}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - USER_SERVICE_URL=http://user-service:${USER_SERVICE_PORT}
      - MASTERDATA_SERVICE_URL=http://masterdata-service:${MASTERDATA_SERVICE_PORT}
      - INVENTORY_SERVICE_URL=http://inventory-service:${INVENTORY_SERVICE_PORT}
      - ORDER_PROCESSING_SERVICE_URL=http://order-processing-service:${ORDER_PROCESSING_SERVICE_PORT}
      - SIMAL_INTEGRATION_SERVICE_URL=http://simal-integration-service:${SIMAL_INTEGRATION_SERVICE_PORT}
    depends_on:
      - user-service
      - masterdata-service
      - inventory-service
      - order-processing-service
      - simal-integration-service
    networks:
      - lego-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_GATEWAY_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==============================================
  # USER SERVICE - Authentication & User Management
  # ==============================================
  user-service:
    build:
      context: ./lego-factory-backend/user-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=${USER_SERVICE_PORT}
      - JWT_SECRET=${SECURITY_JWT_SECRET}
      - SECURITY_JWT_EXPIRATION=${SECURITY_JWT_EXPIRATION}
      - SPRING_DATASOURCE_URL=${H2_DB_USER_PATH}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.h2.Driver
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.H2Dialect
      - H2_CONSOLE_ENABLED=true
    networks:
      - lego-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${USER_SERVICE_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==============================================
  # MASTERDATA SERVICE - Master Data Management
  # ==============================================
  masterdata-service:
    build:
      context: ./lego-factory-backend/masterdata-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=${MASTERDATA_SERVICE_PORT}
      - SECURITY_JWT_SECRET=${SECURITY_JWT_SECRET}
      - SPRING_DATASOURCE_URL=${H2_DB_MASTERDATA_PATH}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.h2.Driver
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.H2Dialect
      - H2_CONSOLE_ENABLED=true
    networks:
      - lego-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${MASTERDATA_SERVICE_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==============================================
  # INVENTORY SERVICE - Inventory Management
  # ==============================================
  inventory-service:
    build:
      context: ./lego-factory-backend/inventory-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=${INVENTORY_SERVICE_PORT}
      - SECURITY_JWT_SECRET=${SECURITY_JWT_SECRET}
      - SPRING_DATASOURCE_URL=${H2_DB_INVENTORY_PATH}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.h2.Driver
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.H2Dialect
      - H2_CONSOLE_ENABLED=true
    networks:
      - lego-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${INVENTORY_SERVICE_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==============================================
  # ORDER PROCESSING SERVICE - Order Management
  # ==============================================
  order-processing-service:
    build:
      context: ./lego-factory-backend/order-processing-service
      dockerfile: Dockerfile
    environment:
      # Core configuration
      - SERVER_PORT=${ORDER_PROCESSING_SERVICE_PORT}
      - SECURITY_JWT_SECRET=${SECURITY_JWT_SECRET}
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-dev}
      # Database configuration
      - SPRING_DATASOURCE_URL=${H2_DB_ORDER_PROCESSING_PATH}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.h2.Driver
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.H2Dialect
      - H2_CONSOLE_ENABLED=true
      # Service URLs
      - inventory.service.url=http://inventory-service:${INVENTORY_SERVICE_PORT}
      - simal.api.base-url=http://simal-integration-service:${SIMAL_INTEGRATION_SERVICE_PORT}/api
      # Thresholds (externalized configuration)
      - LOT_SIZE_THRESHOLD=${LOT_SIZE_THRESHOLD:-3}
      - MAX_ORDER_ITEMS=${MAX_ORDER_ITEMS:-100}
      - STOCK_RESERVE_MINUTES=${STOCK_RESERVE_MINUTES:-30}
      - STOCK_SAFETY_MARGIN_PERCENT=${STOCK_SAFETY_MARGIN_PERCENT:-10}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      # Timeouts (milliseconds)
      - MASTERDATA_TIMEOUT_MS=${MASTERDATA_TIMEOUT_MS:-5000}
      - INVENTORY_TIMEOUT_MS=${INVENTORY_TIMEOUT_MS:-10000}
      - SIMAL_TIMEOUT_MS=${SIMAL_TIMEOUT_MS:-30000}
      # Feature flags
      - ENABLE_CACHING=${ENABLE_CACHING:-false}
      - ENABLE_ASYNC_PROCESSING=${ENABLE_ASYNC_PROCESSING:-false}
      - ENABLE_CIRCUIT_BREAKER=${ENABLE_CIRCUIT_BREAKER:-false}
      - ENABLE_DETAILED_LOGGING=${ENABLE_DETAILED_LOGGING:-true}
      - ENABLE_AUTO_STATUS_PROPAGATION=${ENABLE_AUTO_STATUS_PROPAGATION:-true}
    networks:
      - lego-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${ORDER_PROCESSING_SERVICE_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==============================================
  # SIMAL INTEGRATION SERVICE - External System Integration
  # ==============================================
  simal-integration-service:
    build:
      context: ./lego-factory-backend/simal-integration-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=${SIMAL_INTEGRATION_SERVICE_PORT}
      - SECURITY_JWT_SECRET=${SECURITY_JWT_SECRET}
      - SPRING_DATASOURCE_URL=${H2_DB_SIMAL_INTEGRATION_PATH}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.h2.Driver
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.H2Dialect
      - H2_CONSOLE_ENABLED=true
    networks:
      - lego-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${SIMAL_INTEGRATION_SERVICE_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ==============================================
# NETWORKS
# ==============================================
networks:
  lego-network:
    driver: bridge
    name: lego-network

# ==============================================
# VOLUMES (Optional - for H2 data persistence)
# ==============================================
volumes:
  user_h2_data:
  masterdata_h2_data:
  inventory_h2_data:
  order_processing_h2_data:
  simal_h2_data: